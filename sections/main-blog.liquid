<script
  src="{{ 'blog-posts-list.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

<script>
  // Sticky blog title that shrinks on scroll
  document.addEventListener('DOMContentLoaded', function() {
    const blogTitle = document.querySelector('.blog-posts > .text-block');
    const titleText = blogTitle ? blogTitle.querySelector('p') : null;
    
    if (!blogTitle || !titleText) {
      console.log('Blog title not found');
      return;
    }
    
    // Try multiple selectors to find the Shopify header
    let header = document.querySelector('#shopify-section-header');
    if (!header) header = document.querySelector('.shopify-section-header');
    if (!header) header = document.querySelector('header.header');
    if (!header) header = document.querySelector('.site-header');
    if (!header) header = document.querySelector('header[role="banner"]');
    if (!header) header = document.querySelector('header');
    if (!header) header = document.querySelector('[id*="shopify-section-header"]');
    
    console.log('Found header:', header);
    if (!header) {
      console.log('Header not found - trying to find any element with "header" in class/id');
      // List all potential headers
      const allHeaders = document.querySelectorAll('[class*="header"], [id*="header"]');
      console.log('All potential headers:', allHeaders);
      if (allHeaders.length > 0) {
        header = allHeaders[0];
        console.log('Using first potential header:', header);
      }
    }
    
    // Scroll range where shrinking happens
    const scrollStart = 0;      // Start shrinking immediately
    const scrollEnd = 400;      // Stop shrinking at 400px
    
    // Font size range (in vw units for responsiveness)
    const maxFontSize = 7;      // 7vw at top
    const minFontSize = 2.5;    // 2.5vw when fully scrolled
    
    // Setup header auto-hide
    if (header) {
      header.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
    }
    
    function handleScroll() {
      const scrollY = window.scrollY;
      
      // Calculate progress (0 to 1)
      let progress = 0;
      if (scrollY >= scrollEnd) {
        progress = 1;
      } else if (scrollY > scrollStart) {
        progress = (scrollY - scrollStart) / (scrollEnd - scrollStart);
      }
      
      // Calculate current font size and apply via CSS variable (works with !important)
      const currentFontSize = maxFontSize - (progress * (maxFontSize - minFontSize));
      // Write CSS variable on both the container and the <p> to ensure it takes effect
      blogTitle.style.setProperty('--blog-title-vw', currentFontSize + 'vw');
      titleText.style.setProperty('--blog-title-vw', currentFontSize + 'vw');
      
      // Gradient background starts fading in after title has shrunk (after 150px scroll)
      const backgroundStart = 150; // Start showing background after this point
      const backgroundEnd = 450;   // Fully opaque at this point
      
      let backgroundProgress = 0;
      if (scrollY >= backgroundEnd) {
        backgroundProgress = 1;
      } else if (scrollY > backgroundStart) {
        backgroundProgress = (scrollY - backgroundStart) / (backgroundEnd - backgroundStart);
      }
      
      if (backgroundProgress > 0) {
        const gradientOpacity = 0.95 * backgroundProgress;
        blogTitle.style.background = `linear-gradient(to bottom, rgba(255, 255, 255, ${gradientOpacity}) 0%, rgba(255, 255, 255, ${gradientOpacity * 0.4}) 60%, rgba(255, 255, 255, 0) 85%, transparent 100%)`;
        blogTitle.style.backdropFilter = `blur(${10 * backgroundProgress}px)`;
        blogTitle.style.boxShadow = 'none';
        blogTitle.style.padding = '0.5rem 0';
      } else {
        blogTitle.style.background = 'transparent';
        blogTitle.style.backdropFilter = 'blur(0px)';
        blogTitle.style.boxShadow = 'none';
        blogTitle.style.padding = '0 0 2rem 0';
      }
      
      // Auto-hide Shopify header - only show at very top
      if (header) {
        if (scrollY < 50) {
          // Show header only when at the very top
          header.style.transform = 'translateY(0)';
          header.style.opacity = '1';
          header.style.pointerEvents = 'auto';
        } else {
          // Hide header everywhere else
          header.style.transform = 'translateY(-100%)';
          header.style.opacity = '0';
          header.style.pointerEvents = 'none';
        }
      }
    }
    
    // Initial check
    handleScroll();
    
    // Listen to scroll events with throttling for performance
    let ticking = false;
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    });
  });
</script>

<blog-posts-list section-id="{{ section.id }}">
  <div class="section-background section-background--blog color-{{ section.settings.color_scheme }}"></div>
  <div
    class="
      section
      color-{{ section.settings.color_scheme }}
      blog-posts
      spacing-style
      size-style
    "
    style="{% render 'spacing-style', settings: section.settings %}"
  >
    {%- comment -%} Category navigation buttons {%- endcomment -%}
    <div class="blog-category-nav">
      {%- liquid
        assign has_culture = false
        assign has_history = false
        assign has_theme = false
        assign has_misc = false

        for tag in current_tags
          assign h = tag | handleize
          case h
            when 'culture'
              assign has_culture = true
            when 'history'
              assign has_history = true
            when 'theme'
              assign has_theme = true
            when 'misc'
              assign has_misc = true
          endcase
        endfor
      -%}

      <a href="{{ blog.url }}" class="blog-category-btn{% if current_tags == blank %} active{% endif %}">All</a>
      <a href="{{ blog.url }}/tagged/culture" class="blog-category-btn{% if has_culture %} active{% endif %}">Culture</a>
      <a href="{{ blog.url }}/tagged/history" class="blog-category-btn{% if has_history %} active{% endif %}">History</a>
      <a href="{{ blog.url }}/tagged/theme" class="blog-category-btn{% if has_theme %} active{% endif %}">Theme</a>
      <a href="{{ blog.url }}/tagged/misc" class="blog-category-btn{% if has_misc %} active{% endif %}">Misc</a>
    </div>

    {% content_for 'blocks' %}

    {%- paginate blog.articles by 12 -%}
      <span ref="viewMorePrevious"></span>
      
      {%- comment -%} First 6 articles (rows 1-3): 1 featured + 2 + 3 {%- endcomment -%}
      <div
        ref="grid"
        class="blog-posts-container blog-posts-container--above-banner"
        data-last-page="{{ paginate.pages }}"
      >
        {% for article in blog.articles limit: 6 %}
          <div
            class="blog-post-item{% if forloop.first %} featured-article{% endif %}"
            ref="cards[]"
            data-page="{{ paginate.current_page }}"
          >
            {% content_for 'block', id: 'static-blog-post-card', type: '_blog-post-card', article: article %}
          </div>
        {% endfor %}
      </div>
      
  {%- comment -%} Newsletter banner after first 3 rows {%- endcomment -%}
  {%- capture banner_logo -%}
    {%- if section.settings.banner_logo != blank -%}
      <img
        src="{{ section.settings.banner_logo | image_url: width: 200 }}"
        alt="Newsletter logo"
        class="newsletter-banner__logo-img"
      >
    {%- else -%}
      <span class="newsletter-banner__logo">ব</span>
    {%- endif -%}
  {%- endcapture -%}
  <div class="newsletter-banner-wrapper">
    <a href="#newsletter-signup" class="newsletter-banner">
      <div class="newsletter-banner__track">
        <div class="newsletter-banner__content">
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
        </div>
        <div class="newsletter-banner__content" aria-hidden="true">
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
          {{ banner_logo }}
          <span class="newsletter-banner__text">SIGN UP TO OUR NEWSLETTER</span>
        </div>
      </div>
    </a>
  </div>
  
  {%- comment -%} Social media buttons section {%- endcomment -%}
  <div class="social-media-buttons-wrapper">
    <div class="social-media-buttons">
      <a href="https://www.instagram.com/the.bideshi/" class="social-media-button social-media-button--instagram" target="_blank" rel="noopener noreferrer">
        <span class="social-media-button__text">Instagram</span>
        <span class="social-media-button__icon">↗</span>
      </a>
      <a href="https://www.youtube.com/@TheBideshi" class="social-media-button social-media-button--youtube" target="_blank" rel="noopener noreferrer">
        <span class="social-media-button__text">YouTube</span>
        <span class="social-media-button__icon">↗</span>
      </a>
    </div>
  </div>
  
  {%- comment -%} Articles after newsletter banner - all in rows of 3 {%- endcomment -%}
  <div
    ref="grid"
    class="blog-posts-container blog-posts-container--below-banner"
    data-last-page="{{ paginate.pages }}"
  >
    {% for article in blog.articles %}
      {% if forloop.index > 6 %}
        <div
          class="blog-post-item"
          ref="cards[]"
          data-page="{{ paginate.current_page }}"
        >
          {% content_for 'block', id: 'static-blog-post-card', type: '_blog-post-card', article: article %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
  
  <span ref="viewMoreNext"></span>
  {%- endpaginate -%}
  </div>
</blog-posts-list>

{% stylesheet %}
  /**
   * Blog posts page layout
   */
  .blog-posts {
    /*     --page-content-width: var(--narrow-page-width); */
    --page-content-width: var(--normal-page-width);
    --page-width: calc(var(--page-content-width) + (var(--page-margin) * 2));
    --columns-gap: 36px;
    --rows-gap: 36px;
    overflow-x: clip;
    background-color: #d9d9d9;
  }

  /* Background for entire blog section */
  .section-background--blog {
    background-color: #d9d9d9 !important;
  }

  /* Category navigation buttons */
  .blog-category-nav {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 1rem;
    padding: 2rem 2rem 1.5rem 2rem;
    flex-wrap: wrap;
  }

  .blog-category-btn {
    display: inline-block;
    padding: 0.3rem 1rem;
    background-color: #f0f0f0;
    color: #777;
    text-decoration: none;
    border-radius: 9999px;
    font-size: 0.9rem;
    font-weight: 300;
    font-style: italic;
    font-family: 'Georgia', serif;
    letter-spacing: 0.01em;
    transition: all 0.2s ease;
    border: 1px solid #d0d0d0;
    box-shadow: 
      2px 2px 4px rgba(0, 0, 0, 0.1),
      -1px -1px 3px rgba(255, 255, 255, 0.8);
  }

  .blog-category-btn:hover {
    background-color: #e8e8e8;
    color: #666;
    transform: translateY(-1px);
    box-shadow: 
      3px 3px 6px rgba(0, 0, 0, 0.12),
      -2px -2px 4px rgba(255, 255, 255, 0.9);
  }

  .blog-category-btn.active {
    background-color: #333;
    color: #fff;
    font-weight: 500;
    box-shadow: 
      inset 2px 2px 6px rgba(0, 0, 0, 0.4),
      inset -1px -1px 2px rgba(255, 255, 255, 0.1);
  }

  @media screen and (max-width: 749px) {
    .blog-category-nav {
      padding: 1.5rem 1rem 1rem 1rem;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .blog-category-btn {
      padding: 0.3rem 0.9rem;
      font-size: 0.85rem;
    }
  }

  /* Newspaper-style blog title */
  .blog-posts > .text-block {
    text-align: center !important;
    background-color: transparent !important;
    --padding-block-start: 0px !important;
    --padding-inline-start: 0px !important;
    --padding-inline-end: 0px !important;
    margin-bottom: 0 !important;
    margin-inline: calc(50% - 50vw) !important;
    width: 100vw !important;
    max-width: 100vw !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: sticky !important;
    top: 0 !important;
    z-index: 100 !important;
    box-sizing: border-box !important;
    overflow-wrap: break-word !important;
    padding: 0 0 2rem 0 !important;
    transition: padding 0.2s ease-out, background 0.2s ease-out, backdrop-filter 0.2s ease-out !important;
    backdrop-filter: blur(0px) !important;
  }

  .blog-posts > .text-block p {
    font-family: 'Playfair Display', 'Georgia', serif !important;
    font-size: clamp(1.5rem, var(--blog-title-vw, 7vw), 9.5rem) !important;
    font-weight: 900 !important;
    letter-spacing: 0.12em !important;
    text-transform: uppercase !important;
    line-height: 1.1 !important;
    margin: 0 auto !important;
    padding: 0 !important;
    color: #2c2c2c !important;
    text-align: center !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    hyphens: auto !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    transition: font-size 0.1s ease-out !important;
  }

  @media screen and (max-width: 749px) {
    .blog-posts > .text-block p {
      font-size: clamp(1.2rem, var(--blog-title-vw, 7vw), 3.5rem) !important;
      letter-spacing: 0.08em !important;
    }
  }

  @media screen and (max-width: 1024px) and (min-width: 750px) {
    .blog-posts > .text-block p {
      font-size: clamp(2rem, var(--blog-title-vw, 7vw), 7rem) !important;
    }
  }

  .blog-posts-container {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 1rem;
    width: 100%;
    column-gap: var(--columns-gap);
    row-gap: var(--rows-gap);
    align-items: stretch;
  }

  /**
   * Apart from the first and second rows in the grid, all remaining blog posts
   * are arranged in a three-column layout:
   * +------------+------------+-------------+
   * |            |            |             |
   * |  (span 2)  |  (span 2)  |  (span 2)   |
   * |            |            |             |
   * +------------+------------+-------------+
   */
  .blog-post-item {
    --blog-post-card-scale: 0.6;
    display: flex;
    height: 100%;

    grid-column: span 2;

    @media screen and (max-width: 749px) {
      --blog-post-card-scale: 0.5;

      grid-column: span 6;
    }
  }

  /**
   * The second row of blog posts has two columns:
   * +-------------------+-------------------+
   * |                   |                   |
   * |  (column span 3)  |  (column span 3)  |
   * |                   |                   |
   * +-------------------+-------------------+
   */
  .blog-posts-container--above-banner .blog-post-item:nth-child(2),
  .blog-posts-container--above-banner .blog-post-item:nth-child(3) {
    --blog-post-card-scale: 0.7;
    display: flex;
    height: 100%;

    grid-column: span 3;

    @media screen and (max-width: 749px) {
      --blog-post-card-scale: 0.5;

      grid-column: span 6;
    }
  }

  /**
   * Make images square for all rows except the first (featured) article
   * This applies to row 2, 3, and all rows below the banner
   */
  .blog-posts-container--above-banner .blog-post-item:not(:first-child) .blog-post-card__image-container,
  .blog-posts-container--below-banner .blog-post-item .blog-post-card__image-container {
    aspect-ratio: 1 / 1;
    overflow: hidden;
  }

  .blog-posts-container--above-banner .blog-post-item:not(:first-child) .blog-post-card__image-container img,
  .blog-posts-container--below-banner .blog-post-item .blog-post-card__image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  /**
   * The first row of blog posts has only one column:
   * +---------------------------------------+
   * |                                       |
   * |           (1 column span 6)           |
   * |                                       |
   * +---------------------------------------+
   */
  .blog-posts-container--above-banner .blog-post-item:first-child {
    --blog-post-card-scale: 1;
    display: flex;
    height: auto;
    min-height: 0;

    /* Span entire grid and bleed to viewport edges */
    grid-column: 1 / -1;
    margin-inline: calc(50% - 50vw);
  }

  /**
   * Articles below banner: all use default 3-per-row layout (span 2 each)
   * No special styling for first, second, or third items
   */
  .blog-posts-container--below-banner .blog-post-item {
    grid-column: span 2;
  }

  /**
   * Blog post item styling - removed old border styling as cards now have their own styling
   */
  .blog-post-item {
    padding: 0;
  }

  .blog-post-item:has(.blog-post-card__image-container) {
    padding: 0;
  }

  /* Ensure equal heights for cards in the same row */
  .blog-posts-container .blog-post-item {
    align-self: stretch;
  }

  .blog-posts-container--above-banner .blog-post-item:nth-child(2),
  .blog-posts-container--above-banner .blog-post-item:nth-child(3) {
    align-self: stretch;
  }

  /**
   * Newsletter Marquee Banner
   */
  .newsletter-banner-wrapper {
    width: 100vw;
    overflow: hidden;
    margin: 3rem 0 0 0;
    position: relative;
    left: 50%;
    transform: translateX(-50%);
  }

  .newsletter-banner {
    display: block;
    background-color: #fbbf24;
    padding: 2.5rem 0;
    overflow: hidden;
    text-decoration: none;
    border-top: 3px solid #000;
    border-bottom: 3px solid #000;
    width: 100%;
    --banner-font-size: 4.5rem; /* shared size for text and logo image */
  }

  .newsletter-banner__track {
    display: inline-flex;
    white-space: nowrap;
    animation: scroll-marquee 20s linear infinite;
    will-change: transform;
  }

  .newsletter-banner__content {
    display: inline-flex;
    align-items: center;
    gap: 3rem;
    white-space: nowrap;
    padding-right: 33.5rem; /* increased spacing to prevent overlap at seam */
  }

  .newsletter-banner__logo {
    font-size: var(--banner-font-size);
    font-weight: 700;
    color: #000;
    line-height: 1;
  }

  .newsletter-banner__text {
    font-family: 'Playfair Display', 'Georgia', serif;
    font-size: var(--banner-font-size);
    font-weight: 700;
    font-style: italic;
    color: #000;
    letter-spacing: 0.05em;
    line-height: 1;
  }
  
  /* Logo image sized to match text height dynamically */
  .newsletter-banner__logo-img {
    height: var(--banner-font-size); /* match text size */
    width: auto;
    display: inline-block;
    vertical-align: baseline;
  }

  @keyframes scroll-marquee {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /**
   * Social Media Buttons Section
   */
  .social-media-buttons-wrapper {
    width: 100vw;
    margin: 0 0 3rem 0;
    position: relative;
    left: 50%;
    transform: translateX(-50%);
  }

  .social-media-buttons {
    display: flex;
    background-color: #d9d9d9;
    border-top: none; /* Remove top border since newsletter banner has bottom border */
    border-bottom: 3px solid #000;
    width: 100%;
  }

  .social-media-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 1.5rem 2rem;
    text-decoration: none;
    color: #000;
    font-family: 'Playfair Display', 'Georgia', serif;
    font-size: 2.5rem;
    font-weight: 400;
    transition: background-color 0.2s ease;
    position: relative;
  }

  .social-media-button:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background-color: #000;
  }

  .social-media-button:hover {
    background-color: #fbbf24;
  }

  .social-media-button__text {
    display: block;
    text-align: left;
    flex: 1;
  }

  .social-media-button__icon {
    display: inline-block;
    font-size: 1.75rem;
    vertical-align: middle;
    line-height: 1;
    flex-shrink: 0;
  }

  @media screen and (max-width: 749px) {
    .newsletter-banner {
      padding: 1.5rem 0;
      --banner-font-size: 2rem; /* mobile scale */
    }

    .newsletter-banner__content {
      gap: 2rem;
    }

    .newsletter-banner__logo { font-size: var(--banner-font-size); }
    .newsletter-banner__text { font-size: var(--banner-font-size); }
    .newsletter-banner__logo-img { height: var(--banner-font-size); }

    .social-media-button {
      padding: 1.25rem 1.5rem;
      font-size: 1.3rem;
    }

    .social-media-button__icon {
      font-size: 1.1rem;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.blog_posts",
  "blocks": [
    {
      "type": "@theme"
    },
    {
      "type": "@app"
    },
    {
      "type": "text"
    },
    {
      "type": "icon"
    },
    {
      "type": "image"
    },
    {
      "type": "button"
    },
    {
      "type": "video"
    },
    {
      "type": "group"
    },
    {
      "type": "spacer"
    },
    {
      "type": "_divider"
    }
  ],
  "disabled_on": {
    "groups": ["header"]
  },
  "settings": [
    {
      "type": "image_picker",
      "id": "banner_logo",
      "label": "Newsletter banner logo image"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ]
}
{% endschema %}
